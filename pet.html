<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>펫 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <!-- 뒤로가기 버튼 -->
    <button onclick="loadPage('menu.html')" class="mb-4 flex items-center text-blue-600 hover:underline">
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      메뉴로 돌아가기
    </button>
    <h1 class="text-2xl font-bold text-gray-800 mb-4">🐾 펫 계산기</h1>
    <form id="petForm" class="space-y-4">
      <div id="petGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
        <div><label class="block font-semibold">보유 펫먹이</label><input type="number" id="own-펫먹이" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">보유 조련매뉴얼</label><input type="number" id="own-조련매뉴얼" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">보유 활력의약</label><input type="number" id="own-활력의약" class="w-full border rounded p-2" /></div>
        <div><label class="block font-semibold">보유 강화혈청</label><input type="number" id="own-강화혈청" class="w-full border rounded p-2" /></div>
      </div>
      <button type="button" onclick="calculatePet()" class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600">계산하기</button>
    </form>
  </div>

  <script>
    const grades = ["기간토", "매머드", "호랑이", "코뿔소", "고릴라", "동굴사자", 
                    "흑표범", "큰뿔사슴", 
                    "티타니스", "테이퍼", 
                    "사향소", "북극늑대",
                    "하이에나"];
    const gradeLabels = {
      "기간토": "SSR",
      "매머드": "SSR",
      "호랑이": "SSR",
      "코뿔소": "SSR", 
      "고릴라": "SSR", 
      "동굴사자": "SSR",
      "흑표범": "SR",
      "큰뿔사슴": "SR",
      "티타니스": "R",
      "테이퍼": "R", 
      "사향소": "N",
      "북극늑대": "N",
      "하이에나": "UnKnown"
    };

    const petGrid = document.getElementById("petGrid");
    let petDataMap = {};

    async function fetchPetCSV(gradeKey) {
      const url = `https://raw.githubusercontent.com/s574shinchan/WOS_Calc/main/data/Pet/Pet_${gradeKey}.csv`;
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.trim().split("n");
      const headers = lines[0].split(",");
      const data = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim() || "0");
        return obj;
      });
      return data;
    }

    async function loadPetUI() {
      for (let grade of grades) {
        const gradeKey = gradeLabels[grade];
        const displayGrade = gradeLabels[grade] === "UnKnown" ? "하이에나" : grade;
        const data = await fetchPetCSV(gradeKey);
        if (!data || data.length === 0) continue;

        const petNames = [...new Set(data.map(d => d["이름"]))];
        petDataMap[grade] = data;

        petNames.forEach((petName, index) => {
          const petId = `${grade}-${index}`;
          const petLevels = data.filter(d => d["이름"] === petName).map(d => d["레벨"]);

          petGrid.innerHTML += `
            <div class="border p-2 rounded bg-pink-50 text-xs w-full">
              <label class="flex items-center text-sm font-semibold mb-1">
                <input type="checkbox" id="pet-check-${petId}" class="mr-1 w-4 h-4 accent-pink-500" />
                ${displayGrade}
              </label>
              <div class="flex items-center gap-2 mb-1">
                <label class="text-sm whitespace-nowrap">현재</label>
                <select id="pet-cur-${petId}" class="w-full border rounded py-1 px-2 text-sm">
                  ${petLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("")}
                </select>
              </div>
              <div class="flex items-center gap-2">
                <label class="text-sm whitespace-nowrap">목표</label>
                <select id="pet-tgt-${petId}" class="w-full border rounded py-1 px-2 text-sm">
                  ${petLevels.map(lv => `<option value="${lv}">${lv}</option>`).join("")}
                </select>
              </div>
            </div>
          `;
        });
      }
    }

    function loadPage(page) {
      window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: "650px", width: "100%"}, "*");
    }

    loadPetUI();
  </script>
</body>
</html>
