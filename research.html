<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>연구 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-2 font-sans text-sm">
  <div class="max-w-6xl mx-auto bg-white p-2 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-blue-600 mb-6">🧪 헬리오스 연구 계산기</h1>
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6" id="researchGrid"></div>
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div><label class="block font-semibold">보유 가루</label>
        <input type="number" id="own-가루" class="w-full border rounded p-2" />
      </div>
      <div><label class="block font-semibold">보유 철강재</label>
        <input type="number" id="own-철강재" class="w-full border rounded p-2" />
      </div>
    </div>
    <button onclick="calculateResearch()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg">계산하기</button>
  </div>

  <script>
    const researchList = [
      { key: 'I', label: '불꽃 부대', max: 5 },
      { key: 'II-A', label: '파괴력 연구', max: 8 },
      { key: 'II-B', label: 'HP 연구)', max: 8 },
      { key: 'III', label: '불꽃 군단', max: 12 },
      { key: 'IV-A', label: '공격력 연구', max: 12 },
      { key: 'IV-B', label: '방어력 연구', max: 12 },
      { key: 'V', label: '헬리오스 병사', max: 12 },
      { key: 'Healing', label: '치료', max: 10 },
      { key: 'Training', label: '훈련', max: 10 },
      { key: 'HealingTime', label: '구급', max: 10 },
    ];

    const researchData = {};
    researchList.forEach(item => {
      const data = [];
      for (let i = 1; i <= item.max; i++) {
        data.push({ level: i, 가루: i * 20 + 10, 철강재: i * 5000 + 3000 });
      }
      researchData[item.key] = data;
    });

    function createLevelOptions(max) {
      return Array.from({ length: max + 1 }, (_, i) => `<option value="${i}">${i}</option>`).join('');
    }

    function renderResearchCards() {
      const container = document.getElementById("researchGrid");
      researchList.forEach(item => {
        const div = document.createElement("div");
        div.className = "bg-gray-50 border border-gray-300 p-4 rounded-xl shadow";

        div.innerHTML = `
          <div class="flex items-center mb-2">
            <input type="checkbox" id="check-${item.key}" class="mr-2">
            <label for="check-${item.key}" class="mr-1 w-4 h-4 ext-gray-800">${item.label}</label>
          </div>
          <div class="mb-2">
            <label class="block text-gray-700 font-semibold mb-1">현재 레벨</label>
            <select id="current-${item.key}" class="w-full border rounded px-2 py-1">
              ${createLevelOptions(item.max)}
            </select>
          </div>
          <div>
            <label class="block text-gray-700 font-semibold mb-1">목표 레벨</label>
            <select id="target-${item.key}" class="w-full border rounded px-2 py-1">
              ${createLevelOptions(item.max)}
            </select>
          </div>
        `;

        container.appendChild(div);
      });
    }

    function calculateResearch() {
      let total = { 가루: 0, 철강재: 0 };
      let rows = "";

      researchList.forEach(item => {
        const checked = document.getElementById(`check-${item.key}`).checked;
        if (!checked) return;

        const cur = parseInt(document.getElementById(`current-${item.key}`).value);
        const tgt = parseInt(document.getElementById(`target-${item.key}`).value);
        if (cur >= tgt) return;

        const data = researchData[item.key];
        const subtotal = { 가루: 0, 철강재: 0 };

        for (let i = cur + 1; i <= tgt; i++) {
          const row = data.find(r => r.level === i);
          if (!row) continue;
          subtotal.가루 += parseFloat(row.가루 || 0);
          subtotal.철강재 += parseFloat(row.철강재 || 0);
        }

        total.가루 += subtotal.가루;
        total.철강재 += subtotal.철강재;

        rows += `
          <tr class="text-center">
            <td class="border p-1">${item.label}</td>
            <td class="border p-1">${cur} → ${tgt}</td>
            <td class="border p-1">${subtotal.가루.toLocaleString()}</td>
            <td class="border p-1">${subtotal.철강재.toLocaleString()}</td>
          </tr>
        `;
      });

      const owned = {
        가루: parseFloat(document.getElementById("own-가루").value) || 0,
        철강재: parseFloat(document.getElementById("own-철강재").value) || 0,
      };

      rows += `
        <tr class="text-center font-bold bg-purple-100">
          <td class="border p-1" colspan="2">총합</td>
          <td class="border p-1">${total.가루.toLocaleString()}</td>
          <td class="border p-1">${total.철강재.toLocaleString()}</td>
        </tr>
        <tr class="text-center font-bold bg-red-50">
          <td class="border p-1" colspan="2">과부족</td>
          <td class="border p-1">${(owned.가루 - total.가루).toLocaleString()}</td>
          <td class="border p-1">${(owned.철강재 - total.철강재).toLocaleString()}</td>
        </tr>
      `;

      const resultHTML = `
        <table class="w-full table-auto border text-sm text-center mt-4">
          <thead class="bg-gray-100">
            <tr>
              <th class="border p-1">연구</th>
              <th class="border p-1">레벨</th>
              <th class="border p-1">가루</th>
              <th class="border p-1">철강재</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      window.parent.postMessage({ type: "RESULT_POPUP", html: resultHTML }, "*");
    }
    
    function loadPage(page) {
      window.location.href = page;
      window.parent.postMessage({ type: "SET_FRAME_SIZE", height: "550px", width: "100%"}, "*");
    }
    renderResearchCards();
  </script>
  <script>
    document.addEventListener("contextmenu", event => event.preventDefault());
    document.addEventListener("keydown", function (e) {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
        (e.ctrlKey && (e.key === "U" || e.key === "S"))) 
      {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
