<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>연구 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-2 text-sm font-sans">
  <div class="max-w-5xl mx-auto bg-white p-2 rounded-xl shadow-md">
    <button onclick="loadPage('menu.html')" class="mb-4 flex items-center text-blue-600 hover:underline text-sm">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      메뉴로 돌아가기
    </button>
    <h1 class="text-2xl font-bold text-gray-800 mb-4">🧪 헬리오스 계산기</h1>
    <form id="researchForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="researchCards"></div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4">
        <div><label class="block font-semibold text-gray-700">보유 불수가루</label>
          <input type="number" id="owned-불수가루" class="w-full border rounded p-2" value="0" />
        </div>
        <div><label class="block font-semibold text-gray-700">보유 철강재</label>
          <input type="number" id="owned-철강재" class="w-full border rounded p-2" value="0" />
        </div>
      </div>
        <button type="button" onclick="calcResearch()" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">계산하기</button>
      </div>
    </form>
  </div>

  <script>
    function loadPage(page) {
        window.location.href = page;
        window.parent.postMessage({ type: "SET_FRAME_SIZE", height: "550px", width: "100%"}, "*");
    }

    const researchList = [
      { key: 'I', label: '연구 I', max: 5 },
      { key: 'II-A', label: '연구 II (1)', max: 8 },
      { key: 'II-B', label: '연구 II (2)', max: 8 },
      { key: 'III', label: '연구 III', max: 12 },
      { key: 'IV-A', label: '연구 IV (1)', max: 12 },
      { key: 'IV-B', label: '연구 IV (2)', max: 12 },
      { key: 'V', label: '연구 V', max: 12 },
      { key: 'Healing', label: '치유 연구', max: 10 },
      { key: 'Training', label: '훈련 연구', max: 10 },
      { key: 'HealingTime', label: '치유시간 연구', max: 10 }
    ];

    const columnMap = {
      I: { red: 1, black: 2 }, 
      "II-A": { red: 3, black: 4 }, 
      "II-B": { red: 3, black: 4 },
      III: { red: 5, black: 6 },
      "IV-A": { red: 7, black: 8 }, 
      "IV-B": { red: 7, black: 8 },
      V: { red: 9, black: 10 },
      Healing: { red: 12, black: 13 },
      Training: { red: 14, black: 15 },
      HealingTime: { red: 16, black: 17 }
    };

    function generateOptions(min, max) {
      return Array.from({ length: max - min + 1 }, (_, i) => {
        const lv = i + min;
        return `<option value="${lv}">Lv.${lv}</option>`;
      }).join('');
    }

    function renderResearchCards() {
      const container = document.getElementById("researchCards");
      researchList.forEach((item, idx) => {
        container.innerHTML += `
          <div class="bg-orange-50 border rounded p-2 space-y-2">
            <label class="inline-flex items-center space-x-2 font-bold text-gray-700">
              <input type="checkbox" id="check-${item.key}" class="mr-1 w-4 h-4 accent-orange-500" />
              <span>${item.label}</span>
            </label>
            <div class="flex items-center gap-2">
              <label for="start-${item.key}" class="text-sm whitespace-nowrap">현재</label>
              <select class="flex-1 border rounded p-1" id="start-${item.key}">
                ${generateOptions(1, item.max - 1)}
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label for="end-${item.key}" class="text-sm whitespace-nowrap">목표</label>
              <select class="flex-1 border rounded p-1" id="end-${item.key}">
                ${generateOptions(2, item.max)}
              </select>
            </div>
          </div>
        `;
      });
    }

    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return text.trim().split("\n").map(row => row.split(","));
    }

    async function calcResearch() {
      const data = await fetchCSV("https://raw.githubusercontent.com/s574shinchan/WOS_Calc/1e960927a7b4db6971bcb03227b5fa351ee9d04a/data/research_data.csv");

      let total = { "불수가루": 0, "철강재": 0 };
      let result = `
          <table class="w-full border text-sm text-center table-auto mt-4">
            <thead class="bg-orange-100">
              <tr>
                <th class="border p-1">항목</th>
                <th class="border p-1">레벨</th>
                <th class="border p-1">불수가루</th>
                <th class="border p-1">철강재</th>
              </tr>
            </thead>
            <tbody>
        `;

      researchList.forEach(item => {
        if (!document.getElementById(`check-${item.key}`).checked) 
          return;
        
        const start = parseInt(document.getElementById(`start-${item.key}`).value);
        const end = parseInt(document.getElementById(`end-${item.key}`).value);
        const col = columnMap[item.key];

        let subtotal = { "불수가루": 0, "철강재": 0 };
        for (let i = start - 1; i < end - 1; i++) {
          const row = data[i + 1];
          if (!row) continue;
          subtotal["불수가루"] += parseInt(row[col.red]?.replace(/,/g, "") || 0);
          subtotal["철강재"] += parseInt(row[col.black]?.replace(/,/g, "") || 0);
        }

        total["불수가루"] += subtotal["불수가루"];
        total["철강재"] += subtotal["철강재"];

        row += `
        <tr class="text-center">
        <td class="border p-1">${item.label}</td>
        <td class="border p-1">${start} → ${end}</td>
        <td class="border p-1">${subtotal.불수가루.toLocaleString()}</td>
        <td class="border p-1">${subtotal.철강재.toLocaleString()}</td>
        </tr>`;
      });

      const owned = {
        "불수가루": parseInt(document.getElementById("owned-불수가루").value || 0),
        "철강재": parseInt(document.getElementById("owned-철강재").value || 0)
      };

      result += `
        <tr class="bg-blue-50 font-bold">
          <td class="border p-1" colspan="2">총합</td>
          <td class="border p-1">${total["불수가루"].toLocaleString()}</td>
          <td class="border p-1">${total["철강재"].toLocaleString()}</td>
        </tr>
        <tr class="text-center font-bold bg-red-50">
          <td class="border p-1" colspan="2">과부족</td>
          <td class="border p-1">${(owned["불수가루"] - total["불수가루"]).toLocaleString()}</td>
          <td class="border p-1">${(owned["철강재"] - total["철강재"]).toLocaleString()}</td>
        </tr>
        </tbody></table>`;
      
      const resultHTML = `
      <table class="w-full table-auto border mt-4 text-sm text-center">
      <thead class="bg-gray-100">
      <tr>
      <th class="border p-1">항목</th>
      <th class="border p-1">레벨</th>
      <th class="border p-1">불수가루</th>
      <th class="border p-1">철강재</th>
      </tr>
      </thead>
      <tbody>${rows}</tbody>
      </table>
      `;
      
      window.parent.postMessage({ type: "RESULT_POPUP", html: resultHTML }, "*");
    }

    renderResearchCards();
  </script>
</body>
</html>
